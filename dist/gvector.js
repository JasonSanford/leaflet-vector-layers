/*
 Copyright (c) 2011, Jason Sanford
 Google Vector Layers is a library for showing geometry objects
 from multiple geoweb services with the Google Maps API
*/
(function(a){a.gvector={VERSION:"1.0.0",ROOT_URL:function(){var a=document.getElementsByTagName("script"),e=/^(.*\/)gvector\-?([\w\-]*)\.js.*$/,c,d,f;c=0;for(d=a.length;c<d;c++)if(f=a[c].src,f=f.match(e)){if(f[2]==="include")break;return f[1]}return"../../dist/"}(),noConflict:function(){a.gvector=this._originalgvector;return this},_originalgvector:a.gvector}})(this);/*
 Using portions of Leaflet code (https://github.com/CloudMade/Leaflet)
*/
gvector.Util={extend:function(a){for(var b=Array.prototype.slice.call(arguments,1),e=0,c=b.length,d;e<c;e++){d=b[e]||{};for(var f in d)d.hasOwnProperty(f)&&(a[f]=d[f])}return a},setOptions:function(a,b){a.options=gvector.Util.extend({},a.options,b)}};/*
 Using portions of Leaflet code (https://github.com/CloudMade/Leaflet)
*/
gvector.Class=function(){};
gvector.Class.extend=function(a){var b=function(){this.initialize&&this.initialize.apply(this,arguments)},e=function(){};e.prototype=this.prototype;e=new e;e.constructor=b;b.prototype=e;b.superclass=this.prototype;for(var c in this)this.hasOwnProperty(c)&&c!="prototype"&&c!="superclass"&&(b[c]=this[c]);a.statics&&(gvector.Util.extend(b,a.statics),delete a.statics);a.includes&&(gvector.Util.extend.apply(null,[e].concat(a.includes)),delete a.includes);if(a.options&&e.options)a.options=gvector.Util.extend({},
e.options,a.options);gvector.Util.extend(e,a);b.extend=arguments.callee;b.include=function(a){gvector.Util.extend(this.prototype,a)};return b};gvector.Layer=gvector.Class.extend({options:{fields:"",scaleRange:null,map:null,uniqueField:null,visibleAtScale:!0,dynamic:!1,autoUpdate:!1,autoUpdateInterval:null,infoWindowTemplate:null,singleInfoWindow:!1,symbology:null,showAll:!1},initialize:function(a){gvector.Util.setOptions(this,a)},setMap:function(a){if(!a||!this.options.map){if((this.options.map=a)&&this.options.scaleRange&&this.options.scaleRange instanceof Array&&this.options.scaleRange.length===2){var b=this.options.map.getZoom(),e=this.options.scaleRange;
this.options.visibleAtScale=b>=e[0]&&b<=e[1]}this[a?"_show":"_hide"]()}},getMap:function(){return this.options.map},setOptions:function(){},_show:function(){this._addIdleListener();this.options.scaleRange&&this.options.scaleRange instanceof Array&&this.options.scaleRange.length===2&&this._addZoomChangeListener();if(this.options.visibleAtScale){if(this.options.autoUpdate&&this.options.autoUpdateInterval){var a=this;this._autoUpdateInterval=setInterval(function(){a._getFeatures()},this.options.autoUpdateInterval)}google.maps.event.trigger(this.options.map,
"zoom_changed");google.maps.event.trigger(this.options.map,"idle")}},_hide:function(){this._idleListener&&google.maps.event.removeListener(this._idleListener);this._zoomChangeListener&&google.maps.event.removeListener(this._zoomChangeListener);this._autoUpdateInterval&&clearInterval(this._autoUpdateInterval);this._clearFeatures();this._lastQueriedBounds=null;if(this._gotAll)this._gotAll=!1},_hideVectors:function(){for(var a=0;a<this._vectors.length;a++){if(this._vectors[a].vector)if(this._vectors[a].vector.setMap(null),
this._vectors[a].infoWindow)this._vectors[a].infoWindow.close();else if(this.infoWindow&&this.infoWindow.get("associatedFeature")&&this.infoWindow.get("associatedFeature")==this._vectors[a])this.infoWindow.close(),this.infoWindow=null;if(this._vectors[a].vectors&&this._vectors[a].vectors.length)for(var b=0;b<this._vectors[a].vectors.length;b++)if(this._vectors[a].vectors[b].setMap(null),this._vectors[a].vectors[b].infoWindow)this._vectors[a].vectors[b].infoWindow.close();else if(this.infoWindow&&
this.infoWindow.get("associatedFeature")&&this.infoWindow.get("associatedFeature")==this._vectors[a])this.infoWindow.close(),this.infoWindow=null}},_showVectors:function(){for(var a=0;a<this._vectors.length;a++)if(this._vectors[a].vector&&this._vectors[a].vector.setMap(this.options.map),this._vectors[a].vectors&&this._vectors[a].vectors.length)for(var b=0;b<this._vectors[a].vectors.length;b++)this._vectors[a].vectors[b].setMap(this.options.map)},_clearFeatures:function(){this._hideVectors();this._vectors=
[]},_addZoomChangeListener:function(){var a=this;this._zoomChangeListener=google.maps.event.addListener(this.options.map,"zoom_changed",function(){a._checkLayerVisibility()})},_addIdleListener:function(){var a=this;this._idleListener=google.maps.event.addListener(this.options.map,"idle",function(){if(a.options.visibleAtScale)if(a.options.showAll){if(!a._gotAll)a._getFeatures(),a._gotAll=!0}else a._getFeatures()})},_checkLayerVisibility:function(){var a=this.options.visibleAtScale,b=this.options.map.getZoom(),
e=this.options.scaleRange;this.options.visibleAtScale=b>=e[0]&&b<=e[1];if(a!==this.options.visibleAtScale)this[this.options.visibleAtScale?"_showVectors":"_hideVectors"]();if(a&&!this.options.visibleAtScale&&this._autoUpdateInterval)clearInterval(this._autoUpdateInterval);else if(!a&&this.options.autoUpdate&&this.options.autoUpdateInterval){var c=this;this._autoUpdateInterval=setInterval(function(){c._getFeatures()},this.options.autoUpdateInterval)}},_setInfoWindowContent:function(a){var b=a.iwContent,
e=a.attributes||a.properties,c;if(typeof this.options.infoWindowTemplate=="string"){c=this.options.infoWindowTemplate;for(var d in e)c=c.replace(RegExp("{"+d+"}","g"),e[d])}else if(typeof this.options.infoWindowTemplate=="function")c=this.options.infoWindowTemplate(e);else return;a.iwContent=c;a.infoWindow&&a.iwContent!=b&&a.infoWindow.setContent(a.iwContent)},_showInfoWindow:function(a,b){var e={content:a.iwContent},c;if(this.options.singleInfoWindow){if(this.infoWindow)this.infoWindow.close(),this.infoWindow=
null;this.infoWindow=new google.maps.InfoWindow(e);this.infoWindow.set("associatedFeature",a);c=this}else a.infoWindow=new google.maps.InfoWindow(e),c=a;var d=!1;if(a.vector){if(a.vector.getPaths||a.vector.getPath)d=!0}else if(a.vectors&&a.vectors.length&&(a.vectors[0].getPaths||a.vectors[0].getPath))d=!0;var f=this;setTimeout(function(){c.infoWindow.open(f.options.map,d?new google.maps.Marker({position:b.latLng}):a.vector)},200)},_buildBoundsString:function(a){a=a.toUrlValue().split(",");return a[1]+
","+a[0]+","+a[3]+","+a[2]},_getFeatureVectorOptions:function(a){var b={},a=a.attributes||a.properties;if(this.options.symbology)switch(this.options.symbology.type){case "single":for(var e in this.options.symbology.vectorOptions)b[e]=this.options.symbology.vectorOptions[e];break;case "unique":for(var c=this.options.symbology.property,d=0,f=this.options.symbology.values.length;d<f;d++)if(a[c]==this.options.symbology.values[d].value)for(e in this.options.symbology.values[d].vectorOptions)b[e]=this.options.symbology.values[d].vectorOptions[e];
break;case "range":c=this.options.symbology.property;d=0;for(f=this.options.symbology.ranges.length;d<f;d++)if(a[c]>=this.options.symbology.ranges[d].range[0]&&a[c]<=this.options.symbology.ranges[d].range[1])for(e in this.options.symbology.ranges[d].vectorOptions)b[e]=this.options.symbology.ranges[d].vectorOptions[e]}return b},_getPropertiesChanged:function(a,b){var e=!1,c;for(c in a)a[c]!=b[c]&&(e=!0);return e},_getGeometryChanged:function(a,b){var e=!1;a.coordinates&&a.coordinates instanceof Array?
a.coordinates[0]==b.coordinates[0]&&a.coordinates[1]==b.coordinates[1]||(e=!0):a.x==b.x&&a.y==b.y||(e=!0);return e},_esriJsonGeometryToGoogle:function(a,b){var e,c;if(a.x&&a.y)b.position=new google.maps.LatLng(a.y,a.x),e=new google.maps.Marker(b);else if(a.points){c=[];for(var d=0,f=a.points.length;d<f;d++)b.position=new google.maps.LatLng(a.points[d].y,a.points[d].x),c.push(new google.maps.Marker(b))}else if(a.paths)if(a.paths.length>1){c=[];d=0;for(f=a.paths.length;d<f;d++){for(var g=[],h=0,i=a.paths[d].length;h<
i;h++)g.push(new google.maps.LatLng(a.paths[d][h][1],a.paths[d][h][0]));b.path=g;c.push(new google.maps.Polyline(b))}}else{g=[];d=0;for(f=a.paths[0].length;d<f;d++)g.push(new google.maps.LatLng(a.paths[0][d][1],a.paths[0][d][0]));b.path=g;e=new google.maps.Polyline(b)}else if(a.rings)if(a.rings.length>1){c=[];d=0;for(f=a.rings.length;d<f;d++){for(var j=[],g=[],h=0,i=a.rings[d].length;h<i;h++)g.push(new google.maps.LatLng(a.rings[d][h][1],a.rings[d][h][0]));j.push(g);b.paths=j;c.push(new google.maps.Polygon(b))}}else{j=
[];g=[];d=0;for(f=a.rings[0].length;d<f;d++)g.push(new google.maps.LatLng(a.rings[0][d][1],a.rings[0][d][0]));j.push(g);b.paths=j;e=new google.maps.Polygon(b)}return e||c},_geoJsonGeometryToGoogle:function(a,b){var e,c;switch(a.type){case "Point":b.position=new google.maps.LatLng(a.coordinates[1],a.coordinates[0]);e=new google.maps.Marker(b);break;case "MultiPoint":c=[];for(var d=0,f=a.coordinates.length;d<f;d++)b.position=new google.maps.LatLng(a.coordinates[d][1],a.coordinates[d][0]),c.push(new google.maps.Marker(b));
break;case "LineString":for(var g=[],d=0,f=a.coordinates.length;d<f;d++){var h=new google.maps.LatLng(a.coordinates[d][1],a.coordinates[d][0]);g.push(h)}b.path=g;e=new google.maps.Polyline(b);break;case "MultiLineString":c=[];d=0;for(f=a.coordinates.length;d<f;d++){for(var g=[],i=0,j=a.coordinates[d].length;i<j;i++){var k=a.coordinates[d][i],h=new google.maps.LatLng(k[1],k[0]);g.push(h)}b.path=g;c.push(new google.maps.Polyline(b))}break;case "Polygon":k=[];d=0;for(f=a.coordinates.length;d<f;d++){g=
[];i=0;for(j=a.coordinates[d].length;i<j;i++)h=new google.maps.LatLng(a.coordinates[d][i][1],a.coordinates[d][i][0]),g.push(h);k.push(g)}b.paths=k;e=new google.maps.Polygon(b);break;case "MultiPolygon":c=[];d=0;for(f=a.coordinates.length;d<f;d++){k=[];i=0;for(j=a.coordinates[d].length;i<j;i++){for(var g=[],h=0,l=a.coordinates[d][i].length;h<l;h++)g.push(new google.maps.LatLng(a.coordinates[d][i][h][1],a.coordinates[d][i][h][0]));k.push(g)}b.paths=k;c.push(new google.maps.Polygon(b))}break;case "GeometryCollection":c=
[];d=0;for(f=a.geometries.length;d<f;d++)c.push(this._geoJsonGeometryToGoogle(a.geometries[d],b))}return e||c},_makeJsonpRequest:function(a){var b=document.getElementsByTagName("head")[0],e=document.createElement("script");e.type="text/javascript";e.src=a;b.appendChild(e)}});gvector.AGS=gvector.Layer.extend({initialize:function(a){for(var b=0,e=this._requiredParams.length;b<e;b++)if(!a[this._requiredParams[b]])throw Error('No "'+this._requiredParams[b]+'" parameter found.');this._globalPointer="AGS_"+Math.floor(Math.random()*1E5);window[this._globalPointer]=this;a.url.substr(a.url.length-1,1)!=="/"&&(a.url+="/");this._originalOptions=gvector.Util.extend({},a);if(a.esriOptions)if(typeof a.esriOptions=="object")gvector.Util.extend(a,this._convertEsriOptions(a.esriOptions));
else{this._getEsriOptions();return}gvector.Layer.prototype.initialize.call(this,a);if(this.options.where)this.options.where=encodeURIComponent(this.options.where);this._vectors=[];if(this.options.map){if(this.options.scaleRange&&this.options.scaleRange instanceof Array&&this.options.scaleRange.length===2)a=this.options.map.getZoom(),b=this.options.scaleRange,this.options.visibleAtScale=a>=b[0]&&a<=b[1];this._show()}},options:{where:"1=1",url:null,useEsriOptions:!1},_requiredParams:["url"],_convertEsriOptions:function(a){var b=
{};if(!(a.minScale==void 0||a.maxScale==void 0)){var e=this._scaleToLevel(a.minScale),c=this._scaleToLevel(a.maxScale);c==0&&(c=20);b.scaleRange=[e,c]}if(a.drawingInfo&&a.drawingInfo.renderer)b.symbology=this._renderOptionsToSymbology(a.drawingInfo.renderer);return b},_getEsriOptions:function(){this._makeJsonpRequest(this._originalOptions.url+"?f=json&callback="+this._globalPointer+"._processEsriOptions")},_processEsriOptions:function(a){var b=this._originalOptions;b.esriOptions=a;this.initialize(b)},
_scaleToLevel:function(a){var b=[5.91657527591555E8,2.95828763795777E8,1.47914381897889E8,7.3957190948944E7,3.6978595474472E7,1.8489297737236E7,9244648.868618,4622324.434309,2311162.217155,1155581.108577,577790.554289,288895.277144,144447.638572,72223.819286,36111.909643,18055.954822,9027.977411,4513.988705,2256.994353,1128.497176,564.248588,282.124294];if(a==0)return 0;for(var e=0,c=0;c<b.length-1;c++){var d=b[c+1];if(a<=b[c]&&a>d){e=c;break}}return e},_renderOptionsToSymbology:function(a){symbology=
{};switch(a.type){case "simple":symbology.type="single";symbology.vectorOptions=this._parseSymbology(a.symbol);break;case "uniqueValue":symbology.type="unique";symbology.property=a.field1;for(var b=[],e=0;e<a.uniqueValueInfos.length;e++){var c=a.uniqueValueInfos[e],d={};d.value=c.value;d.vectorOptions=this._parseSymbology(c.symbol);d.label=c.label;b.push(d)}symbology.values=b;break;case "classBreaks":symbology.type="range";symbology.property=rend.field;b=[];c=a.minValue;for(e=0;e<a.classBreakInfos.length;e++){var d=
a.classBreakInfos[e],f={};f.range=[c,d.classMaxValue];c=d.classMaxValue;f.vectorOptions=this._parseSymbology(d.symbol);f.label=d.label;b.push(f)}symbology.ranges=b}return symbology},_parseSymbology:function(a){var b={};switch(a.type){case "esriSMS":case "esriPMS":b.icon="data:image/gif;base64,"+a.imageData;break;case "esriSLS":b.strokeWeight=a.width;b.strokeColor=this._parseColor(a.color);b.strokeOpacity=this._parseAlpha(a.color[3]);break;case "esriSFS":a.outline?(b.strokeWeight=a.outline.width,b.strokeColor=
this._parseColor(a.outline.color),b.strokeOpacity=this._parseAlpha(a.outline.color[3])):(b.strokeWeight=0,b.strokeColor="#000000",b.strokeOpacity=0),a.style!="esriSFSNull"?(b.fillColor=this._parseColor(a.color),b.fillOpacity=this._parseAlpha(a.color[3])):(b.fillColor="#000000",b.fillOpacity=0)}return b},_parseColor:function(a){red=this._normalize(a[0]);green=this._normalize(a[1]);blue=this._normalize(a[2]);return"#"+this._pad(red.toString(16))+this._pad(green.toString(16))+this._pad(blue.toString(16))},
_normalize:function(a){return a<1&&a>0?Math.floor(a*255):a},_pad:function(a){return a.length>1?a.toUpperCase():"0"+a.toUpperCase()},_parseAlpha:function(a){return a/255},_getFeatures:function(){this.options.uniqueField||this._clearFeatures();var a=this.options.url+"query?returnGeometry=true&outSR=4326&f=json&outFields="+this.options.fields+"&where="+this.options.where+"&callback="+this._globalPointer+"._processFeatures";this.options.showAll||(a+="&inSR=4326&spatialRel=esriSpatialRelIntersects&geometryType=esriGeometryEnvelope&geometry="+
this._buildBoundsString(this.options.map.getBounds()));this._makeJsonpRequest(a)},_processFeatures:function(a){if(this.options.map){var b=this.options.map.getBounds();if(!this._lastQueriedBounds||!this._lastQueriedBounds.equals(b)||this._autoUpdateInterval)if(this._lastQueriedBounds=b,a&&a.features&&a.features.length)for(b=0;b<a.features.length;b++){var e=!1;if(this.options.uniqueField)for(var c=0;c<this._vectors.length;c++)if(a.features[b].attributes[this.options.uniqueField]==this._vectors[c].attributes[this.options.uniqueField]&&
(e=!0,this.options.dynamic)){if(this._getGeometryChanged(this._vectors[c].geometry,a.features[b].geometry)&&!isNaN(a.features[b].geometry.x)&&!isNaN(a.features[b].geometry.y))this._vectors[c].geometry=a.features[b].geometry,this._vectors[c].vector.setPosition(new google.maps.LatLng(this._vectors[c].geometry.y,this._vectors[c].geometry.x));if(this._getPropertiesChanged(this._vectors[c].attributes,a.features[b].attributes))this._vectors[c].attributes=a.features[b].attributes,this.options.infoWindowTemplate&&
this._setInfoWindowContent(this._vectors[c]),this.options.symbology&&this.options.symbology.type!="single"&&this._vectors[c].vector.setOptions(this._getFeatureVectorOptions(this._vectors[c]))}if(!e||!this.options.uniqueField){e=this._esriJsonGeometryToGoogle(a.features[b].geometry,this._getFeatureVectorOptions(a.features[b]));a.features[b][e instanceof Array?"vectors":"vector"]=e;if(a.features[b].vector)a.features[b].vector.setMap(this.options.map);else if(a.features[b].vectors&&a.features[b].vectors.length)for(e=
0;e<a.features[b].vectors.length;e++)a.features[b].vectors[e].setMap(this.options.map);this._vectors.push(a.features[b]);if(this.options.infoWindowTemplate){var d=this,e=a.features[b];this._setInfoWindowContent(e);(function(a){if(a.vector)google.maps.event.addListener(a.vector,"click",function(b){d._showInfoWindow(a,b)});else if(a.vectors)for(var b=0,c=a.vectors.length;b<c;b++)google.maps.event.addListener(a.vectors[b],"click",function(b){d._showInfoWindow(a,b)})})(e)}}}}}});gvector.GeoIQ=gvector.Layer.extend({initialize:function(a){for(var b=0,e=this._requiredParams.length;b<e;b++)if(!a[this._requiredParams[b]])throw Error('No "'+this._requiredParams[b]+'" parameter found.');gvector.Layer.prototype.initialize.call(this,a);this._globalPointer="GeoIQ_"+Math.floor(Math.random()*1E5);window[this._globalPointer]=this;this._vectors=[];if(this.options.map){if(this.options.scaleRange&&this.options.scaleRange instanceof Array&&this.options.scaleRange.length===2)a=this.options.map.getZoom(),
b=this.options.scaleRange,this.options.visibleAtScale=a>=b[0]&&a<=b[1];this._show()}},options:{dataset:null},_requiredParams:["dataset"],_getFeatures:function(){this.options.uniqueField||this._clearFeatures();var a="http://geocommons.com/datasets/"+this.options.dataset+"/features.json?geojson=1&callback="+this._globalPointer+"._processFeatures&limit=999";this.options.showAll||(a+="&bbox="+this._buildBoundsString(this.options.map.getBounds())+"&intersect=full");this._makeJsonpRequest(a)},_processFeatures:function(a){if(this.options.map){var a=
JSON.parse(a),b=this.options.map.getBounds();if(!this._lastQueriedBounds||!this._lastQueriedBounds.equals(b)||this._autoUpdateInterval)if(this._lastQueriedBounds=b,a&&a.features&&a.features.length)for(b=0;b<a.features.length;b++){var e=!1;if(this.options.uniqueField)for(var c=0;c<this._vectors.length;c++)if(a.features[b].properties[this.options.uniqueField]==this._vectors[c].properties[this.options.uniqueField]&&(e=!0,this.options.dynamic)){if(this._getGeometryChanged(this._vectors[c].geometry,a.features[b].geometry)&&
!isNaN(a.features[b].geometry.coordinates[0])&&!isNaN(a.features[b].geometry.coordinates[1]))this._vectors[c].geometry=a.features[b].geometry,this._vectors[c].vector.setPosition(new google.maps.LatLng(this._vectors[c].geometry.coordinates[1],this._vectors[c].geometry.coordinates[0]));if(this._getPropertiesChanged(this._vectors[c].properties,a.features[b].properties)&&(this._vectors[c].properties=a.features[b].properties,this.options.infoWindowTemplate&&this._setInfoWindowContent(this._vectors[c]),
this.options.symbology&&this.options.symbology.type!="single"))if(this._vectors[c].vector)this._vectors[c].vector.setOptions(this._getFeatureVectorOptions(this._vectors[c]));else if(this._vectors[c].vectors)for(var d=0,f=this._vectors[c].vectors.length;d<f;d++)this._vectors[c].vectors[d].setOptions(this._getFeatureVectorOptions(this._vectors[c]))}if(!e||!this.options.uniqueField){e=this._geoJsonGeometryToGoogle(a.features[b].geometry,this._getFeatureVectorOptions(a.features[b]));a.features[b][e instanceof
Array?"vectors":"vector"]=e;if(a.features[b].vector)a.features[b].vector.setMap(this.options.map);else if(a.features[b].vectors&&a.features[b].vectors.length)for(d=0;d<a.features[b].vectors.length;d++)a.features[b].vectors[d].setMap(this.options.map);this._vectors.push(a.features[b]);if(this.options.infoWindowTemplate){var g=this,e=a.features[b];this._setInfoWindowContent(e);(function(a){if(a.vector)google.maps.event.addListener(a.vector,"click",function(b){g._showInfoWindow(a,b)});else if(a.vectors)for(var b=
0,c=a.vectors.length;b<c;b++)google.maps.event.addListener(a.vectors[b],"click",function(b){g._showInfoWindow(a,b)})})(e)}}}}}});gvector.CartoDB=gvector.Layer.extend({initialize:function(a){for(var b=0,e=this._requiredParams.length;b<e;b++)if(!a[this._requiredParams[b]])throw Error('No "'+this._requiredParams[b]+'" parameter found.');gvector.Layer.prototype.initialize.call(this,a);this._globalPointer="CartoDB_"+Math.floor(Math.random()*1E5);window[this._globalPointer]=this;this._vectors=[];if(this.options.map){if(this.options.scaleRange&&this.options.scaleRange instanceof Array&&this.options.scaleRange.length===2)a=this.options.map.getZoom(),
b=this.options.scaleRange,this.options.visibleAtScale=a>=b[0]&&a<=b[1];this._show()}},options:{version:1,user:null,table:null,fields:"*",where:null,limit:null,uniqueField:"cartodb_id"},_requiredParams:["user","table"],_getFeatures:function(){var a=this.options.where||"";if(!this.options.showAll)for(var b=this.options.map.getBounds(),e=b.getSouthWest(),b=b.getNorthEast(),c=this.options.table.split(",").length,d=0;d<c;d++)a+=(a.length?" AND ":"")+(c>1?this.options.table.split(",")[d].split(".")[0]+
".the_geom":"the_geom")+" && st_setsrid(st_makebox2d(st_point("+e.lng()+","+e.lat()+"),st_point("+b.lng()+","+b.lat()+")),4326)";this.options.limit&&(a+=(a.length?" ":"")+"limit "+this.options.limit);a=a.length?" "+a:"";this._makeJsonpRequest("http://"+this.options.user+".cartodb.com/api/v"+this.options.version+"/sql?q="+encodeURIComponent("SELECT "+this.options.fields+" FROM "+this.options.table+(a.length?" WHERE "+a:""))+"&format=geojson&callback="+this._globalPointer+"._processFeatures")},_processFeatures:function(a){if(this.options.map){var b=
this.options.map.getBounds();if(!this._lastQueriedBounds||!this._lastQueriedBounds.equals(b)||this._autoUpdateInterval)if(this._lastQueriedBounds=b,a&&a.features&&a.features.length)for(b=0;b<a.features.length;b++){var e=!1;if(this.options.uniqueField)for(var c=0;c<this._vectors.length;c++)if(a.features[b].properties[this.options.uniqueField]==this._vectors[c].properties[this.options.uniqueField]&&(e=!0,this.options.dynamic)){if(this._getGeometryChanged(this._vectors[c].geometry,a.features[b].geometry)&&
!isNaN(a.features[b].geometry.coordinates[0])&&!isNaN(a.features[b].geometry.coordinates[1]))this._vectors[c].geometry=a.features[b].geometry,this._vectors[c].vector.setPosition(new google.maps.LatLng(this._vectors[c].geometry.coordinates[1],this._vectors[c].geometry.coordinates[0]));if(this._getPropertiesChanged(this._vectors[c].properties,a.features[b].properties)&&(this._vectors[c].properties=a.features[b].properties,this.options.infoWindowTemplate&&this._setInfoWindowContent(this._vectors[c]),
this.options.symbology&&this.options.symbology.type!="single"))if(this._vectors[c].vector)this._vectors[c].vector.setOptions(this._getFeatureVectorOptions(this._vectors[c]));else if(this._vectors[c].vectors)for(var d=0,f=this._vectors[c].vectors.length;d<f;d++)this._vectors[c].vectors[d].setOptions(this._getFeatureVectorOptions(this._vectors[c]))}if(!e||!this.options.uniqueField){e=this._geoJsonGeometryToGoogle(a.features[b].geometry,this._getFeatureVectorOptions(a.features[b]));a.features[b][e instanceof
Array?"vectors":"vector"]=e;if(a.features[b].vector)a.features[b].vector.setMap(this.options.map);else if(a.features[b].vectors&&a.features[b].vectors.length)for(d=0;d<a.features[b].vectors.length;d++)a.features[b].vectors[d].setMap(this.options.map);this._vectors.push(a.features[b]);if(this.options.infoWindowTemplate){var g=this,e=a.features[b];this._setInfoWindowContent(e);(function(a){if(a.vector)google.maps.event.addListener(a.vector,"click",function(b){g._showInfoWindow(a,b)});else if(a.vectors)for(var b=
0,c=a.vectors.length;b<c;b++)google.maps.event.addListener(a.vectors[b],"click",function(b){g._showInfoWindow(a,b)})})(e)}}}}}});
